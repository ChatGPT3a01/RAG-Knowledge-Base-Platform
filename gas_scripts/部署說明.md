# Google Apps Script 部署說明

## 步驟一：建立 Google 試算表

1. 前往 [Google Sheets](https://sheets.google.com)
2. 建立新試算表
3. 將試算表命名為「RAG 知識庫」

## 步驟二：開啟 Apps Script 編輯器

1. 在試算表中，點擊「擴充功能」→「Apps Script」
2. 會開啟一個新的 Apps Script 專案

## 步驟三：部署 Apps Script 程式碼

1. 刪除預設的 `function myFunction() {}` 程式碼
2. 複製 `知識庫API.gs` 的完整程式碼
3. 貼到 Apps Script 編輯器中
4. 點擊「檔案」→「儲存」（或按 Ctrl+S）

## 步驟四：測試程式碼

1. 在函式下拉選單中選擇 `testAPI`
2. 點擊「執行」按鈕
3. 第一次執行會要求授權，點擊「審查權限」
4. 選擇您的 Google 帳號
5. 點擊「進階」→「前往 XXX（不安全）」
6. 點擊「允許」

## 步驟五：部署為網頁應用程式

1. 點擊右上角「部署」→「新增部署作業」
2. 點擊「選取類型」→「網頁應用程式」
3. 填寫以下資訊：
   - **說明**：RAG 知識庫 API v1.0
   - **執行身分**：我
   - **具有存取權的使用者**：所有人
4. 點擊「部署」
5. 複製「網頁應用程式 URL」（類似：`https://script.google.com/macros/s/.../exec`）

## 步驟六：取得試算表 URL

1. 回到 Google 試算表
2. 複製瀏覽器網址列的完整 URL
3. URL 格式：`https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/edit`

## 步驟七：在本地應用程式中設定

將以下資訊填入本地應用程式的設定：

- **GAS API URL**：步驟五取得的網頁應用程式 URL
- **試算表 URL**：步驟六取得的試算表 URL

## API 端點說明

### GET 請求

#### 取得知識庫列表
```
GET {GAS_API_URL}?action=list
```

#### 搜尋知識庫
```
GET {GAS_API_URL}?action=search&query=關鍵字
```

#### 取得統計資料
```
GET {GAS_API_URL}?action=stats
```

### POST 請求

#### 新增知識
```json
POST {GAS_API_URL}
Content-Type: application/json

{
  "action": "add",
  "question": "問題內容",
  "answer": "答案內容",
  "category": "分類"
}
```

#### 批次新增
```json
POST {GAS_API_URL}
Content-Type: application/json

{
  "action": "batch_add",
  "items": [
    {
      "question": "問題1",
      "answer": "答案1",
      "category": "分類1"
    },
    {
      "question": "問題2",
      "answer": "答案2",
      "category": "分類2"
    }
  ]
}
```

#### 更新知識
```json
POST {GAS_API_URL}
Content-Type: application/json

{
  "action": "update",
  "rowIndex": 2,
  "question": "更新的問題",
  "answer": "更新的答案",
  "category": "更新的分類"
}
```

#### 刪除知識
```json
POST {GAS_API_URL}
Content-Type: application/json

{
  "action": "delete",
  "rowIndex": 2
}
```

## 試算表格式說明

知識庫工作表必須包含以下欄位（標題列）：

| 問題 | 答案 | 分類 | 更新時間 | 來源 |
|------|------|------|----------|------|
| 範例問題 | 範例答案 | 一般 | 2025-10-10 12:00:00 | 手動新增 |

## 常見問題

### Q: 部署後 API 無法存取？
A: 確認「具有存取權的使用者」設定為「所有人」

### Q: 如何更新 API 程式碼？
A: 修改程式碼後，點擊「部署」→「管理部署作業」→ 點擊「編輯」→ 更新版本 → 部署

### Q: 如何查看 API 執行記錄？
A: 在 Apps Script 編輯器中點擊「執行作業」查看執行記錄

### Q: 權限問題如何處理？
A: 重新執行測試函式並重新授權

## 安全性建議

1. **定期備份試算表**：定期下載試算表副本
2. **限制編輯權限**：只給需要的人編輯權限
3. **監控 API 使用**：定期檢查「查詢記錄」工作表
4. **版本控制**：每次更新時在部署說明中註明版本號

## 進階配置

### 自動備份

在 Apps Script 中新增以下函式並設定觸發條件：

```javascript
function autoBackup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const backupName = '知識庫備份_' + new Date().toISOString().split('T')[0];
  ss.copy(backupName);
}
```

設定觸發條件：「觸發條件」→「新增觸發條件」→ 選擇 `autoBackup` → 時間驅動 → 每天

### 存取控制

如需要更嚴格的存取控制，可以在程式碼中新增 API Key 驗證：

```javascript
const API_KEYS = ['your-secret-key-1', 'your-secret-key-2'];

function doGet(e) {
  const apiKey = e.parameter.apiKey;
  if (!API_KEYS.includes(apiKey)) {
    return createResponse(false, '無效的 API Key', null);
  }
  // ... 原有程式碼
}
```
